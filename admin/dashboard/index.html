<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel V2 - Fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6f8; --card: #ffffff; --text: #222;
      --primary: #007bff; --sidebar: #ffffff; --shadow: rgba(0, 0, 0, 0.08);
      --danger: #dc3545; --success: #28a745;
    }
    body.dark {
      --bg: #1e1e2e; --card: #2a2a3d; --text: #eee;
      --sidebar: #252536; --shadow: rgba(0, 0, 0, 0.3);
      --primary: #4f46e5;
    }
    * { box-sizing: border-box; outline: none; transition: background-color .3s, color .3s; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    
    /* SIDEBAR */
    aside {
      width: 260px; background: var(--sidebar);
      box-shadow: 2px 0 10px var(--shadow);
      display: flex; flex-direction: column; padding: 20px;
      position: fixed; top: 0; left: 0; height: 100%; z-index: 1000;
      transform: translateX(-100%); transition: transform .3s ease;
    }
    aside.show { transform: translateX(0); }
    @media(min-width: 992px) {
      aside { transform: translateX(0); }
      main { margin-left: 260px; }
      .hamburger { display: none; }
    }
    
    aside h2 { font-size: 20px; margin-bottom: 30px; color: var(--primary); font-weight: 800; text-align: center; }
    nav button {
      width: 100%; text-align: left; background: transparent; border: none;
      padding: 12px 15px; margin-bottom: 8px; font-size: 15px; cursor: pointer;
      border-radius: 8px; color: var(--text); font-weight: 600;
    }
    nav button:hover, nav button.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }

    /* MAIN CONTENT */
    main { flex: 1; padding: 20px; overflow-y: auto; width: 100%; }
    .page { display: none; animation: fadeIn .4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

    .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 20px; }
    
    /* HEADER */
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .hamburger { font-size: 24px; background: none; border: none; color: var(--text); cursor: pointer; }
    .btn-icon { background: var(--card); border: 1px solid var(--text); color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; }

    /* DASHBOARD CARDS */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .info-card { padding: 20px; border-radius: 12px; color: #fff; position: relative; overflow: hidden; }
    .info-card h3 { font-size: 32px; margin: 0; font-weight: 700; }
    .info-card p { margin: 5px 0 0; opacity: 0.9; font-size: 14px; }
    .info-card .icon { position: absolute; right: 15px; top: 15px; font-size: 40px; opacity: 0.2; }
    
    .g-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .g-green { background: linear-gradient(135deg, #10b981, #059669); }
    .g-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .g-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }

    /* FORMS & TABLES */
    label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text); }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; background: var(--bg); color: var(--text); }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
    
    button.primary { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button.primary:hover { opacity: 0.9; transform: translateY(-1px); }
    button.danger { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--shadow); }
    th { color: var(--text); opacity: 0.7; font-weight: 600; }

    /* LOADING & UTILS */
    .spinner { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin{to{transform:rotate(360deg);}}
    .hidden { display: none; }
    .success-box { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 15px; border-radius: 8px; margin-top: 15px; color: #059669; }

    /* SETTINGS MODAL */
    #configModal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="configModal" class="hidden">
  <div class="card" style="width: 90%; max-width: 400px;">
    <h2 style="text-align: center;">‚öôÔ∏è Setup Awal</h2>
    <p style="text-align: center; font-size: 13px; margin-bottom: 20px; color: gray;">Data disimpan di browser Anda (LocalStorage). Aman.</p>
    
    <label>Domain Panel (Wajib pakai https://)</label>
    <input type="text" id="cfgDomain" placeholder="https://panel.domainanda.com">
    
    <label>API Key (PLTA)</label>
    <input type="password" id="cfgPlta" placeholder="plta_xxxxxxxxxxxx">

    <label>Bot Token (Opsional - Untuk Notif)</label>
    <input type="text" id="cfgBot" placeholder="12345:AAFxxxxx">
    
    <button class="primary" onclick="saveConfig()">Simpan Pengaturan</button>
  </div>
</div>

<aside id="sidebar">
  <h2>üöÄ ADMIN V2</h2>
  <nav>
    <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
    <button class="nav-btn" data-page="server">üñ• List Server</button>
    <button class="nav-btn" data-page="reseller">üë§ Reseller (DB Lokal)</button>
    <button class="nav-btn" data-page="createpanel">üß© Create Panel</button>
    <button class="nav-btn" data-page="createadmin">üîê Create Admin</button>
    <button class="nav-btn" data-page="clearserver">üóë Clear Server</button>
    <button class="nav-btn" onclick="openConfig()" style="margin-top: 20px; border: 1px solid #ccc;">‚öôÔ∏è Pengaturan</button>
  </nav>
</aside>

<main>
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
    <h2 id="pageTitle" style="margin: 0; font-size: 18px;">Dashboard</h2>
    <button class="btn-icon" onclick="toggleDark()">üåô</button>
  </div>

  <div class="page active" id="dashboard">
    <div class="info-grid">
      <div class="info-card g-blue">
        <div class="icon">üë•</div>
        <h3 id="dashUser">0</h3>
        <p>Total Reseller</p>
      </div>
      <div class="info-card g-green">
        <div class="icon">üñ•</div>
        <h3 id="dashServer">0</h3>
        <p>Total Server</p>
      </div>
      <div class="info-card g-purple">
        <div class="icon">üåê</div>
        <h3 id="dashIp">...</h3>
        <p>IP Address Anda</p>
      </div>
    </div>
    
    <div class="card">
      <h3>üìà Statistik</h3>
      <div style="display: flex; align-items: flex-end; height: 150px; gap: 30px; padding-top: 20px;">
        <div style="flex: 1; text-align: center;">
          <div id="barUser" style="height: 0%; background: var(--primary); width: 50px; margin: 0 auto; border-radius: 8px 8px 0 0; transition: height 1s;"></div>
          <span style="font-size: 12px; display: block; margin-top: 5px;">User</span>
        </div>
        <div style="flex: 1; text-align: center;">
          <div id="barServer" style="height: 0%; background: #10b981; width: 50px; margin: 0 auto; border-radius: 8px 8px 0 0; transition: height 1s;"></div>
          <span style="font-size: 12px; display: block; margin-top: 5px;">Server</span>
        </div>
      </div>
    </div>
  </div>

  <div class="page" id="server">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Daftar Server Pterodactyl</h3>
        <button class="primary" style="width: auto;" onclick="loadServers()">üîÑ Refresh</button>
      </div>
      <div style="overflow-x: auto; margin-top: 15px;">
        <table id="tableServer">
          <thead><tr><th>ID</th><th>Nama</th><th>Identifier</th><th>Owner ID</th></tr></thead>
          <tbody><tr><td colspan="4">Klik refresh untuk memuat data...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="page" id="reseller">
    <div class="card">
      <h3>üë§ Manajemen User (Lokal)</h3>
      <p style="font-size: 13px; color: gray;">Fitur ini menggunakan database browser (LocalStorage). Data tidak akan hilang saat refresh, tapi hilang jika cache dihapus.</p>
      
      <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4>Tambah User Baru</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
          <input type="text" id="addResUser" placeholder="Username" style="margin:0">
          <input type="text" id="addResPass" placeholder="Password" style="margin:0">
          <button class="primary" onclick="addReseller()" style="margin:0">Tambah</button>
        </div>
      </div>

      <table id="tableReseller">
        <thead><tr><th>Username</th><th>Password</th><th>Dibuat</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="page" id="createpanel">
    <div class="card" style="max-width: 500px; margin: 0 auto;">
      <h3>üß© Create Panel Pterodactyl</h3>
      
      <div id="cpForm">
        <label>Username Panel</label>
        <input type="text" id="cpUser">
        
        <label>Pilih Paket</label>
        <select id="cpRam">
          <option value="1gb">RAM 1GB</option>
          <option value="2gb">RAM 2GB</option>
          <option value="4gb">RAM 4GB</option>
          <option value="8gb">RAM 8GB</option>
          <option value="unli">Unlimited</option>
        </select>
        
        <label>ID Telegram (Opsional)</label>
        <input type="number" id="cpTele">

        <button class="primary" onclick="processCreatePanel()">Buat Panel</button>
      </div>

      <div id="cpResult" class="success-box hidden">
        <h4>‚úÖ Berhasil Dibuat!</h4>
        <p><strong>URL:</strong> <a id="resUrl" href="#" target="_blank">Login</a></p>
        <p><strong>Email:</strong> <span id="resEmail">-</span></p>
        <p><strong>Username:</strong> <span id="resUname">-</span></p>
        <p><strong>Password:</strong> <span id="resPass">-</span></p>
        <button class="primary" onclick="resetCp()" style="margin-top:10px">Buat Lagi</button>
      </div>
    </div>
  </div>

  <div class="page" id="createadmin">
    <div class="card" style="max-width: 500px; margin: 0 auto;">
      <h3>üîê Buat Admin Panel</h3>
      <label>Username Admin</label>
      <input type="text" id="admUser">
      <button class="primary" onclick="processCreateAdmin()">Jadikan Admin</button>
    </div>
  </div>

  <div class="page" id="clearserver">
    <div class="card" style="text-align: center; max-width: 400px; margin: 0 auto; border: 1px solid var(--danger);">
      <h3 style="color: var(--danger);">‚ö†Ô∏è ZONA BAHAYA</h3>
      <p>Tindakan ini akan menghapus <strong>SEMUA SERVER</strong> di panel Pterodactyl Anda.</p>
      <p>Tidak dapat dibatalkan!</p>
      <button class="danger" onclick="processClearServer()" style="width: 100%; padding: 15px; font-size: 16px;">üî• HAPUS SEMUA SERVER</button>
    </div>
  </div>

</main>

<script>
  /* ================= KONFIGURASI ================= */
  // Kita simpan config di LocalStorage agar aman & dinamis
  function getConfig() {
    return {
      domain: localStorage.getItem('cfg_domain') || '',
      plta: localStorage.getItem('cfg_plta') || '',
      bot: localStorage.getItem('cfg_bot') || ''
    };
  }

  function saveConfig() {
    const d = document.getElementById('cfgDomain').value.replace(/\/$/, ""); // hapus slash akhir
    const p = document.getElementById('cfgPlta').value;
    const b = document.getElementById('cfgBot').value;

    if(!d || !p) return alert("Domain dan PLTA wajib diisi!");

    localStorage.setItem('cfg_domain', d);
    localStorage.setItem('cfg_plta', p);
    localStorage.setItem('cfg_bot', b);
    
    alert("‚úÖ Konfigurasi Tersimpan!");
    document.getElementById('configModal').classList.add('hidden');
    location.reload(); // Refresh agar variabel terupdate
  }

  function openConfig() {
    const c = getConfig();
    document.getElementById('cfgDomain').value = c.domain;
    document.getElementById('cfgPlta').value = c.plta;
    document.getElementById('cfgBot').value = c.bot;
    document.getElementById('configModal').classList.remove('hidden');
  }

  // Cek config saat load
  window.addEventListener('load', () => {
    const c = getConfig();
    if(!c.domain || !c.plta) {
      document.getElementById('configModal').classList.remove('hidden');
    }
    loadResellers(); // Load DB Lokal
    getIp();
    // Coba hitung server jika config ada
    if(c.domain) countServers();
  });

  /* ================= NAVIGASI ================= */
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
  function toggleDark() { document.body.classList.toggle('dark'); }
  
  const buttons = document.querySelectorAll('.nav-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', function() {
      if(this.innerText.includes('Pengaturan')) return; // Skip tombol setting
      
      // Reset active state
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      // Set active
      this.classList.add('active');
      const target = this.getAttribute('data-page');
      document.getElementById(target).classList.add('active');
      document.getElementById('pageTitle').innerText = this.innerText;
      
      // Close sidebar mobile
      if(window.innerWidth < 992) document.getElementById('sidebar').classList.remove('show');
    });
  });

  /* ================= FITUR RESELLER (DATABASE LOKAL) ================= */
  // Ini menggantikan /api/register yang error karena tidak ada backend.
  
  function getResellers() {
    return JSON.parse(localStorage.getItem('db_resellers') || '[]');
  }

  function loadResellers() {
    const users = getResellers();
    const tbody = document.querySelector('#tableReseller tbody');
    tbody.innerHTML = '';
    
    document.getElementById('dashUser').innerText = users.length;
    updateChart(users.length, null); // update grafik user

    if(users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Belum ada user. Tambahkan diatas.</td></tr>';
      return;
    }

    users.forEach((u, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.password}</td>
        <td>${u.date}</td>
        <td><button class="danger" onclick="deleteReseller(${index})">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function addReseller() {
    const u = document.getElementById('addResUser').value;
    const p = document.getElementById('addResPass').value;
    if(!u || !p) return alert("Isi username dan password!");

    const users = getResellers();
    users.push({ username: u, password: p, date: new Date().toLocaleDateString() });
    
    localStorage.setItem('db_resellers', JSON.stringify(users));
    
    document.getElementById('addResUser').value = '';
    document.getElementById('addResPass').value = '';
    loadResellers();
    alert("‚úÖ User berhasil ditambahkan ke database lokal!");
  }

  function deleteReseller(index) {
    if(!confirm("Hapus user ini?")) return;
    const users = getResellers();
    users.splice(index, 1);
    localStorage.setItem('db_resellers', JSON.stringify(users));
    loadResellers();
  }

  /* ================= FITUR SERVER (API PTERODACTYL) ================= */
  const specs = {
    "1gb":{ram:1000,disk:1000,cpu:50},
    "2gb":{ram:2000,disk:2000,cpu:80},
    "4gb":{ram:4000,disk:4000,cpu:120},
    "8gb":{ram:8000,disk:8000,cpu:200},
    "unli":{ram:0,disk:0,cpu:0}
  };

  async function processCreatePanel() {
    const cfg = getConfig();
    const user = document.getElementById('cpUser').value;
    const ram = document.getElementById('cpRam').value;
    const tele = document.getElementById('cpTele').value;
    const spec = specs[ram];

    if(!user) return alert("Username wajib diisi!");

    // Gunakan API Wrapper ResellerGaming atau API Panel Langsung
    // Disini saya pakai wrapper sesuai kode lama Anda agar kompatibel
    const url = `https://api.resellergaming.my.id/pterodactyl/addpanel?domain=${encodeURIComponent(cfg.domain)}&plta=${cfg.plta}&username=${user}&ram=${spec.ram}&disk=${spec.disk}&cpu=${spec.cpu}`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      
      if(data.user) {
        document.getElementById('cpForm').classList.add('hidden');
        document.getElementById('cpResult').classList.remove('hidden');
        
        const u = data.user.attributes;
        document.getElementById('resUrl').href = cfg.domain;
        document.getElementById('resEmail').innerText = u.email;
        document.getElementById('resUname').innerText = u.username;
        document.getElementById('resPass').innerText = u.username; // Password default sama dgn username di API ini

        // Notif Telegram
        if(tele && cfg.bot) {
          const msg = `üì¶ Panel Created!\nDomain: ${cfg.domain}\nUser: ${u.username}\nPass: ${u.username}`;
          fetch(`https://api.telegram.org/bot${cfg.bot}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: tele, text: msg})
          });
        }
      } else {
        alert("Gagal: " + (data.message || JSON.stringify(data)));
      }
    } catch(e) {
      alert("Error Fetch: " + e.message);
    }
  }

  function resetCp() {
    document.getElementById('cpForm').classList.remove('hidden');
    document.getElementById('cpResult').classList.add('hidden');
    document.getElementById('cpUser').value = '';
  }

  /* ================= LIST SERVER & CHART ================= */
  async function loadServers() {
    const cfg = getConfig();
    const tbody = document.querySelector('#tableServer tbody');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center"><div class="spinner"></div>Loading...</td></tr>';

    const url = `https://api.resellergaming.my.id/pterodactyl/listserver?domain=${encodeURIComponent(cfg.domain)}&plta=${cfg.plta}`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      
      if(data.status && data.servers) {
        tbody.innerHTML = '';
        document.getElementById('dashServer').innerText = data.servers.length;
        updateChart(null, data.servers.length);

        data.servers.forEach(s => {
          tbody.innerHTML += `
            <tr>
              <td>${s.attributes ? s.attributes.id : s.id}</td>
              <td>${s.attributes ? s.attributes.name : s.name}</td>
              <td>${s.attributes ? s.attributes.identifier : s.identifier}</td>
              <td>${s.attributes ? s.attributes.user : '-'}</td>
            </tr>`;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="4" style="color:red">Gagal ambil data server / PLTA Salah</td></tr>`;
      }
    } catch(e) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:red">${e.message}</td></tr>`;
    }
  }

  function countServers() {
    // Versi silent untuk dashboard
    loadServers(); 
  }

  function updateChart(userVal, serverVal) {
    if(userVal !== null) {
      let h = Math.min(100, userVal * 10); // Scale visual
      document.getElementById('barUser').style.height = (userVal > 0 ? Math.max(10, h) : 0) + '%';
    }
    if(serverVal !== null) {
      let h = Math.min(100, serverVal * 2); 
      document.getElementById('barServer').style.height = (serverVal > 0 ? Math.max(10, h) : 0) + '%';
    }
  }

  /* ================= TOOLS LAIN ================= */
  async function processCreateAdmin() {
    const cfg = getConfig();
    const u = document.getElementById('admUser').value;
    if(!u) return alert("Username wajib diisi");

    const url = `https://api.resellergaming.my.id/pterodactyl/addadmin?domain=${encodeURIComponent(cfg.domain)}&plta=${cfg.plta}&username=${u}`;
    
    try {
      const r = await fetch(url);
      const d = await r.json();
      if(d.status) alert("‚úÖ Sukses menjadikan admin!");
      else alert("‚ùå Gagal: " + d.message);
    } catch(e) { alert("Error: " + e.message); }
  }

  async function processClearServer() {
    if(!confirm("YAKIN HAPUS SEMUA?")) return;
    const cfg = getConfig();
    // Gunakan endpoint clearserver yang valid (Contoh dari kode lama Anda)
    // NB: Hati-hati API nvidiabotz mungkin mati, sebaiknya buat loop delete sendiri jika API ini mati.
    const url = `https://api.nvidiabotz.xyz/pterodactyl/clearserver?domain=${encodeURIComponent(cfg.domain)}&plta=${cfg.plta}`;
    
    try {
      const r = await fetch(url);
      const d = await r.json();
      alert("Respon: " + JSON.stringify(d));
      loadServers(); // Refresh list
    } catch(e) { alert("Error: " + e.message); }
  }

  function getIp() {
    fetch('https://api.ipify.org?format=json')
      .then(r=>r.json()).then(d=>document.getElementById('dashIp').innerText = d.ip);
  }
</script>
</body>
</html>
